#include <yak/cpu/gdt.h>

.code64
.text

.global idt
.extern interrupt_dispatch

# Orders of pushes when an interrupt is thrown
# CPU:
#   ss, rsp, rflags, cs, rip
# CPU or ISR:
#   err
# ISR:
#   int_no
#   rax, rcx, rdx, rdi, rsi, r8, r9, r10, r11 # not preserved accross function calls
# The C function called by the ISR handler pushes the
# following registers only if it modifies them:
#   rbx, rbp, r12, r13, r14, r15 # preserved accross function calls
# We should not use those registers inside the asm ISR stub since we
# do not push them explicitly

#define PUSHALL \
    pushq %rax; \
    pushq %rcx; \
    pushq %rdx; \
    pushq %rdi; \
    pushq %rsi; \
    pushq %r8; \
    pushq %r9; \
    pushq %r10; \
    pushq %r11; \
    cld

#define POPALL \
    popq %r11; \
    popq %r10; \
    popq %r9; \
    popq %r8; \
    popq %rsi; \
    popq %rdi; \
    popq %rdx; \
    popq %rcx; \
    popq %rax

.type isr_common, @function
isr_common:
    PUSHALL

    movq %rsp, %rdi
    call interrupt_dispatch

    POPALL
    addq $16, %rsp # pop error code and interrupt number
    iretq
.size isr_common, . - isr_common

.macro isr vector, push0=1
    .align 16
    .type isr_\vector, @function
    isr_\vector:
        cli
    .if \push0
        pushq $0xdead
    .endif
        pushq $\vector
        jmp isr_common
    .size isr_\vector, . - isr_\vector
.endm

.macro isr_err vector
    isr \vector, 0
.endm

isr      0
isr      1
isr      2
isr      3
isr      4
isr      5
isr      6
isr      7
isr_err  8
isr      9
isr_err 10
isr_err 11
isr_err 12
isr_err 13
isr_err 14
isr     15
isr     16
isr_err 17
isr     18
isr     19
isr     20
isr     21
isr     22
isr     23
isr     24
isr     25
isr     26
isr     27
isr     28
isr     29
isr     30
isr     31
isr     32
isr     33
isr     34
isr     35
isr     36
isr     37
isr     38
isr     39
isr     40
isr     41
isr     42
isr     43
isr     44
isr     45
isr     46
isr     47
isr     48
isr     49
isr     50
isr     51
isr     52
isr     53
isr     54
isr     55
isr     56
isr     57
isr     58
isr     59
isr     60
isr     61
isr     62
isr     63
isr     64
isr     65
isr     66
isr     67
isr     68
isr     69
isr     70
isr     71
isr     72
isr     73
isr     74
isr     75
isr     76
isr     77
isr     78
isr     79
isr     80
isr     81
isr     82
isr     83
isr     84
isr     85
isr     86
isr     87
isr     88
isr     89
isr     90
isr     91
isr     92
isr     93
isr     94
isr     95
isr     96
isr     97
isr     98
isr     99
isr     100
isr     101
isr     102
isr     103
isr     104
isr     105
isr     106
isr     107
isr     108
isr     109
isr     110
isr     111
isr     112
isr     113
isr     114
isr     115
isr     116
isr     117
isr     118
isr     119
isr     120
isr     121
isr     122
isr     123
isr     124
isr     125
isr     126
isr     127
isr     128
isr     129
isr     130
isr     131
isr     132
isr     133
isr     134
isr     135
isr     136
isr     137
isr     138
isr     139
isr     140
isr     141
isr     142
isr     143
isr     144
isr     145
isr     146
isr     147
isr     148
isr     149
isr     150
isr     151
isr     152
isr     153
isr     154
isr     155
isr     156
isr     157
isr     158
isr     159
isr     160
isr     161
isr     162
isr     163
isr     164
isr     165
isr     166
isr     167
isr     168
isr     169
isr     170
isr     171
isr     172
isr     173
isr     174
isr     175
isr     176
isr     177
isr     178
isr     179
isr     180
isr     181
isr     182
isr     183
isr     184
isr     185
isr     186
isr     187
isr     188
isr     189
isr     190
isr     191
isr     192
isr     193
isr     194
isr     195
isr     196
isr     197
isr     198
isr     199
isr     200
isr     201
isr     202
isr     203
isr     204
isr     205
isr     206
isr     207
isr     208
isr     209
isr     210
isr     211
isr     212
isr     213
isr     214
isr     215
isr     216
isr     217
isr     218
isr     219
isr     220
isr     221
isr     222
isr     223
isr     224
isr     225
isr     226
isr     227
isr     228
isr     229
isr     230
isr     231
isr     232
isr     233
isr     234
isr     235
isr     236
isr     237
isr     238
isr     239
isr     240
isr     241
isr     242
isr     243
isr     244
isr     245
isr     246
isr     247
isr     248
isr     249
isr     250
isr     251
isr     252
isr     253
isr     254
isr     255

.data

# Each IDT entry is 128 bits long
idt:
.quad isr_0
.quad 0
.quad isr_1
.quad 0
.quad isr_2
.quad 0
.quad isr_3
.quad 0
.quad isr_4
.quad 0
.quad isr_5
.quad 0
.quad isr_6
.quad 0
.quad isr_7
.quad 0
.quad isr_8
.quad 0
.quad isr_9
.quad 0
.quad isr_10
.quad 0
.quad isr_11
.quad 0
.quad isr_12
.quad 0
.quad isr_13
.quad 0
.quad isr_14
.quad 0
.quad isr_15
.quad 0
.quad isr_16
.quad 0
.quad isr_17
.quad 0
.quad isr_18
.quad 0
.quad isr_19
.quad 0
.quad isr_20
.quad 0
.quad isr_21
.quad 0
.quad isr_22
.quad 0
.quad isr_23
.quad 0
.quad isr_24
.quad 0
.quad isr_25
.quad 0
.quad isr_26
.quad 0
.quad isr_27
.quad 0
.quad isr_28
.quad 0
.quad isr_29
.quad 0
.quad isr_30
.quad 0
.quad isr_31
.quad 0
.quad isr_32
.quad 0
.quad isr_33
.quad 0
.quad isr_34
.quad 0
.quad isr_35
.quad 0
.quad isr_36
.quad 0
.quad isr_37
.quad 0
.quad isr_38
.quad 0
.quad isr_39
.quad 0
.quad isr_40
.quad 0
.quad isr_41
.quad 0
.quad isr_42
.quad 0
.quad isr_43
.quad 0
.quad isr_44
.quad 0
.quad isr_45
.quad 0
.quad isr_46
.quad 0
.quad isr_47
.quad 0
.quad isr_48
.quad 0
.quad isr_49
.quad 0
.quad isr_50
.quad 0
.quad isr_51
.quad 0
.quad isr_52
.quad 0
.quad isr_53
.quad 0
.quad isr_54
.quad 0
.quad isr_55
.quad 0
.quad isr_56
.quad 0
.quad isr_57
.quad 0
.quad isr_58
.quad 0
.quad isr_59
.quad 0
.quad isr_60
.quad 0
.quad isr_61
.quad 0
.quad isr_62
.quad 0
.quad isr_63
.quad 0
.quad isr_64
.quad 0
.quad isr_65
.quad 0
.quad isr_66
.quad 0
.quad isr_67
.quad 0
.quad isr_68
.quad 0
.quad isr_69
.quad 0
.quad isr_70
.quad 0
.quad isr_71
.quad 0
.quad isr_72
.quad 0
.quad isr_73
.quad 0
.quad isr_74
.quad 0
.quad isr_75
.quad 0
.quad isr_76
.quad 0
.quad isr_77
.quad 0
.quad isr_78
.quad 0
.quad isr_79
.quad 0
.quad isr_80
.quad 0
.quad isr_81
.quad 0
.quad isr_82
.quad 0
.quad isr_83
.quad 0
.quad isr_84
.quad 0
.quad isr_85
.quad 0
.quad isr_86
.quad 0
.quad isr_87
.quad 0
.quad isr_88
.quad 0
.quad isr_89
.quad 0
.quad isr_90
.quad 0
.quad isr_91
.quad 0
.quad isr_92
.quad 0
.quad isr_93
.quad 0
.quad isr_94
.quad 0
.quad isr_95
.quad 0
.quad isr_96
.quad 0
.quad isr_97
.quad 0
.quad isr_98
.quad 0
.quad isr_99
.quad 0
.quad isr_100
.quad 0
.quad isr_101
.quad 0
.quad isr_102
.quad 0
.quad isr_103
.quad 0
.quad isr_104
.quad 0
.quad isr_105
.quad 0
.quad isr_106
.quad 0
.quad isr_107
.quad 0
.quad isr_108
.quad 0
.quad isr_109
.quad 0
.quad isr_110
.quad 0
.quad isr_111
.quad 0
.quad isr_112
.quad 0
.quad isr_113
.quad 0
.quad isr_114
.quad 0
.quad isr_115
.quad 0
.quad isr_116
.quad 0
.quad isr_117
.quad 0
.quad isr_118
.quad 0
.quad isr_119
.quad 0
.quad isr_120
.quad 0
.quad isr_121
.quad 0
.quad isr_122
.quad 0
.quad isr_123
.quad 0
.quad isr_124
.quad 0
.quad isr_125
.quad 0
.quad isr_126
.quad 0
.quad isr_127
.quad 0
.quad isr_128
.quad 0
.quad isr_129
.quad 0
.quad isr_130
.quad 0
.quad isr_131
.quad 0
.quad isr_132
.quad 0
.quad isr_133
.quad 0
.quad isr_134
.quad 0
.quad isr_135
.quad 0
.quad isr_136
.quad 0
.quad isr_137
.quad 0
.quad isr_138
.quad 0
.quad isr_139
.quad 0
.quad isr_140
.quad 0
.quad isr_141
.quad 0
.quad isr_142
.quad 0
.quad isr_143
.quad 0
.quad isr_144
.quad 0
.quad isr_145
.quad 0
.quad isr_146
.quad 0
.quad isr_147
.quad 0
.quad isr_148
.quad 0
.quad isr_149
.quad 0
.quad isr_150
.quad 0
.quad isr_151
.quad 0
.quad isr_152
.quad 0
.quad isr_153
.quad 0
.quad isr_154
.quad 0
.quad isr_155
.quad 0
.quad isr_156
.quad 0
.quad isr_157
.quad 0
.quad isr_158
.quad 0
.quad isr_159
.quad 0
.quad isr_160
.quad 0
.quad isr_161
.quad 0
.quad isr_162
.quad 0
.quad isr_163
.quad 0
.quad isr_164
.quad 0
.quad isr_165
.quad 0
.quad isr_166
.quad 0
.quad isr_167
.quad 0
.quad isr_168
.quad 0
.quad isr_169
.quad 0
.quad isr_170
.quad 0
.quad isr_171
.quad 0
.quad isr_172
.quad 0
.quad isr_173
.quad 0
.quad isr_174
.quad 0
.quad isr_175
.quad 0
.quad isr_176
.quad 0
.quad isr_177
.quad 0
.quad isr_178
.quad 0
.quad isr_179
.quad 0
.quad isr_180
.quad 0
.quad isr_181
.quad 0
.quad isr_182
.quad 0
.quad isr_183
.quad 0
.quad isr_184
.quad 0
.quad isr_185
.quad 0
.quad isr_186
.quad 0
.quad isr_187
.quad 0
.quad isr_188
.quad 0
.quad isr_189
.quad 0
.quad isr_190
.quad 0
.quad isr_191
.quad 0
.quad isr_192
.quad 0
.quad isr_193
.quad 0
.quad isr_194
.quad 0
.quad isr_195
.quad 0
.quad isr_196
.quad 0
.quad isr_197
.quad 0
.quad isr_198
.quad 0
.quad isr_199
.quad 0
.quad isr_200
.quad 0
.quad isr_201
.quad 0
.quad isr_202
.quad 0
.quad isr_203
.quad 0
.quad isr_204
.quad 0
.quad isr_205
.quad 0
.quad isr_206
.quad 0
.quad isr_207
.quad 0
.quad isr_208
.quad 0
.quad isr_209
.quad 0
.quad isr_210
.quad 0
.quad isr_211
.quad 0
.quad isr_212
.quad 0
.quad isr_213
.quad 0
.quad isr_214
.quad 0
.quad isr_215
.quad 0
.quad isr_216
.quad 0
.quad isr_217
.quad 0
.quad isr_218
.quad 0
.quad isr_219
.quad 0
.quad isr_220
.quad 0
.quad isr_221
.quad 0
.quad isr_222
.quad 0
.quad isr_223
.quad 0
.quad isr_224
.quad 0
.quad isr_225
.quad 0
.quad isr_226
.quad 0
.quad isr_227
.quad 0
.quad isr_228
.quad 0
.quad isr_229
.quad 0
.quad isr_230
.quad 0
.quad isr_231
.quad 0
.quad isr_232
.quad 0
.quad isr_233
.quad 0
.quad isr_234
.quad 0
.quad isr_235
.quad 0
.quad isr_236
.quad 0
.quad isr_237
.quad 0
.quad isr_238
.quad 0
.quad isr_239
.quad 0
.quad isr_240
.quad 0
.quad isr_241
.quad 0
.quad isr_242
.quad 0
.quad isr_243
.quad 0
.quad isr_244
.quad 0
.quad isr_245
.quad 0
.quad isr_246
.quad 0
.quad isr_247
.quad 0
.quad isr_248
.quad 0
.quad isr_249
.quad 0
.quad isr_250
.quad 0
.quad isr_251
.quad 0
.quad isr_252
.quad 0
.quad isr_253
.quad 0
.quad isr_254
.quad 0
.quad isr_255
.quad 0

